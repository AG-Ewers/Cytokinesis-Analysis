# -*- coding: utf-8 -*-
"""Time Lapse Processor - v1.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1VzGb8P9KnuDd8AnHhaND-ufVg4E0UMXO
"""

# Install libraries
!pip install tifffile numpy matplotlib Pillow ipywidgets

import tifffile as tiff
import numpy as np
from matplotlib import pyplot as plt
from PIL import Image
import ipywidgets as widgets
from IPython.display import display
import os
import random

"""**To examine the size and structure of the input 5D data.**
Note that the sample file 'mitosis.tif' used here is in the format of **(t, z, c, x, y)**. Please adjust the code accordingly if you are working with data of a different structure.
"""

def process_tiff(file_path, resize_dim):
    try:
        img = tiff.imread(file_path)  # Read the TIFF file

        print("Input shape:", img.shape) # Print the shape of the image for debugging

        # Check if the image has 5 dimensions
        if len(img.shape) != 5:
            print("Error: The TIFF file does not have 5 dimensions (XYZCT)")
            return
    except Exception as e:
        print("An error occurred:", e)

file_path = "/content/mitosis.tif"
resize_dim = [128,128]
process_tiff(file_path, resize_dim)

"""The main process begins here: **the 5D data is converted into 2D images**, which are then stored in a folder named 'frame'.

Note: Ensure you first enter the path to your 5D image in the prompted blank space.
Note: Make sure the new size (x,y) is smaller than the size of the original input image.
Example setting could be like:
![image.png](data:image/png;base64,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)
"""

# Function to read and process the TIFF file
def process_tiff(file_path, resize_dim):

    img = tiff.imread(file_path)   # Read the TIFF file

    # Ensure the 'frames' directory exists
    os.makedirs('frames', exist_ok=True)

    # Process each time frame
    for t in range(img.shape[0]):
        # Composite image for each channel
        composite_image = None

        for c in range(img.shape[2]):
            # Project the Z-axis into XY
            projection = np.max(img[t, :, c, :, :], axis=0)

            # Normalize the projection for visualization
            projection = (projection / np.max(projection) * 255).astype(np.uint8)

            if composite_image is None:
                composite_image = Image.fromarray(projection)
            else:
                # Merge with previous channels
                composite_image = Image.blend(composite_image, Image.fromarray(projection), 0.5)

        # Resize the image
        composite_image = composite_image.resize(resize_dim)

        # Save the image
        composite_image.save(f'frames/frame_{t}.png')

#print("the process is done!")
# Interactive interface
file_path_widget = widgets.Text(description='File Path:')
resize_width_widget = widgets.IntText(value=512, description='Width:')
resize_height_widget = widgets.IntText(value=512, description='Height:')
button = widgets.Button(description='Process')

# Button click event
def on_button_clicked(b):
    process_tiff(file_path_widget.value, (resize_width_widget.value, resize_height_widget.value))

button.on_click(on_button_clicked)

# Display widgets
display(file_path_widget, resize_width_widget, resize_height_widget, button)

"""To randonly visualize 6 output images from the folder 'frame'"""

# Path to the 'frame' folder
folder_path = '/content/frames'

# List all files in the folder
file_list = os.listdir(folder_path)

# Randomly select 6 images
selected_images = random.sample(file_list, 6)
fig, axes = plt.subplots(2, 3, figsize=(15, 10))
axes = axes.flatten()

# Display each image
for ax, image in zip(axes, selected_images):
    img_path = os.path.join(folder_path, image)
    img = Image.open(img_path)
    ax.imshow(img)
    ax.axis('off')
    ax.set_title(image)

plt.tight_layout()
plt.show()